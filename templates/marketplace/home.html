{% extends 'base.html' %}

{% block content %}
    <div class="container mx-auto px-4 py-8">
        <!-- Hero Banner -->
        <div class="theme-container rounded-lg shadow-md mb-8 overflow-hidden relative">
            <div class="h-64 bg-gradient-to-r from-blue-600 to-green-600 flex items-center justify-center text-white text-center p-6">
                <div>
                    <h1 class="text-4xl font-bold">Fresh from Kisumu to You!</h1>
                    <h2 class="text-xl mt-2">Shop Next Doorâ€”Delivered to Your Door. Trust local. Shop Smart</h2>
                    <a href="#products" class="mt-4 inline-block theme-button py-2 px-6 rounded-lg transition-colors duration-300">Shop Now</a>
                </div>
            </div>
        </div>

        <!-- Search Form -->
<div class="theme-container rounded-2xl shadow-lg p-6 mb-8 bg-[var(--card-bg)] border border-[var(--border-color)] border-opacity-10">
    <form method="get" action="{% url 'marketplace:search_products' %}" class="flex flex-col sm:flex-row gap-4 items-center relative">
        <!-- Animated Search Input with External Icon -->
        <div class="relative flex-1 w-full search-container">
            <input type="text" name="q" id="search-input" placeholder="Search..." 
                   class="w-full pl-4 pr-10 py-2 rounded-full 
                          bg-[var(--card-bg)] text-[var(--text-color)] 
                          focus:outline-none focus:ring-2 focus:ring-[var(--button-bg)] 
                          shadow-sm hover:shadow-md transition-all duration-500 
                          placeholder-[var(--placeholder-text)] text-base font-medium 
                          border border-[var(--border-color)]" />
            <button type="submit" class="absolute right-[-10rem] sm:right-[-5rem] top-1/2 transform -translate-y-1/2 text-[var(--text-color)] opacity-60 hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-search text-lg"></i>
            </button>
        </div>
        <!-- Category Button -->
        <div class="relative">
            <button type="button" id="category-btn" class="p-3 rounded-xl bg-[var(--button-bg)] text-[var(--button-text)] 
                                                          hover:bg-[var(--button-hover)] transition-all duration-300 
                                                          shadow-sm hover:shadow-md flex items-center gap-2">
                <i class="fas fa-list"></i>
                <span>Category</span>
            </button>
            <!-- Category Options (Hidden by Default) -->
            <div id="category-options" class="absolute top-12 left-0 bg-[var(--card-bg)] border border-[var(--border-color)] 
                                             rounded-xl shadow-lg p-4 z-10 hidden transform transition-all duration-300 w-[180px]">
                <label for="category-filter" class="text-[var(--text-color)] text-base font-medium">Category</label>
                <select name="category" id="category-filter" class="p-2 rounded-xl w-full mt-1
                                                                 bg-[var(--card-bg)] text-[var(--text-color)] 
                                                                 focus:outline-none focus:ring-2 focus:ring-[var(--button-bg)] 
                                                                 shadow-sm hover:shadow-md transition-all duration-300 text-base font-medium 
                                                                 cursor-pointer border border-[var(--border-color)]">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <!-- Price Filter Button -->
        <div class="relative">
            <button type="button" id="filter-btn" class="p-3 rounded-xl bg-[var(--button-bg)] text-[var(--button-text)] 
                                                        hover:bg-[var(--button-hover)] transition-all duration-300 
                                                        shadow-sm hover:shadow-md flex items-center gap-2">
                <i class="fas fa-filter"></i>
                <span>Filter Price</span>
            </button>
            <!-- Price Filter Options (Hidden by Default) -->
            <div id="filter-options" class="absolute top-12 left-0 bg-[var(--card-bg)] border border-[var(--border-color)] 
                                           rounded-xl shadow-lg p-4 z-10 hidden transform transition-all duration-300 w-[240px]">
                <!-- Price Range Filter -->
                <div class="flex flex-col gap-2">
                    <label class="text-[var(--text-color)] text-base font-medium">Price Range</label>
                    <div class="flex gap-3">
                        <input type="number" name="min_price" placeholder="Min Price" 
                               class="p-2 rounded-xl w-full 
                                      bg-[var(--card-bg)] text-[var(--text-color)] 
                                      focus:outline-none focus:ring-2 focus:ring-[var(--button-bg)] 
                                      shadow-sm hover:shadow-md transition-all duration-300 
                                      placeholder-[var(--placeholder-text)] text-base font-medium 
                                      border border-[var(--border-color)]" min="0">
                        <input type="number" name="max_price" placeholder="Max Price" 
                               class="p-2 rounded-xl w-full 
                                      bg-[var(--card-bg)] text-[var(--text-color)] 
                                      focus:outline-none focus:ring-2 focus:ring-[var(--button-bg)] 
                                      shadow-sm hover:shadow-md transition-all duration-300 
                                      placeholder-[var(--placeholder-text)] text-base font-medium 
                                      border border-[var(--border-color)]" min="0">
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

        <!-- Product Grid -->
        <div id="products" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% if products %}
                {% for product in products %}
                    <a href="{% url 'marketplace:product_detail' product.id %}" class="theme-container rounded-lg shadow-md overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl">
                        <div class="relative overflow-hidden">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-56 object-cover transform transition-transform duration-300 hover:scale-110">
                            {% else %}
                                <div class="w-full h-56 placeholder-container flex items-center justify-center">
                                    <span>No Image</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="p-4">
                            <h2 class="text-lg font-semibold">{{ product.name }}</h2>        
                            <div class="flex items-center mt-1">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= product.full_stars %}
                                        <i class="fas fa-star text-yellow-400"></i>
                                    {% elif forloop.counter == product.full_stars|add:1 and product.has_half_star %}
                                        <i class="fas fa-star-half-alt text-yellow-400"></i>
                                    {% else %}
                                        <i class="far fa-star" style="color: var(--placeholder-text);"></i>
                                    {% endif %}
                                {% endfor %}
                                <span class="ml-2 text-sm" style="color: var(--placeholder-text);">{{ product.rating_display|floatformat:1 }}/5</span>
                            </div>
                            <p>KSh {{ product.price }}</p>
                            <p class="text-sm mt-2" id="desc-{{ product.id }}">
                                {% if product.description|length > 100 %}
                                    {{ product.description|truncatechars:100 }} <a href="#" class="read-more theme-link" data-product-id="{{ product.id }}">read more...</a>
                                    <span class="hidden full-desc">{{ product.description }}</span>
                                {% else %}
                                    {{ product.description }}
                                {% endif %}
                            </p>
                            <button onclick="addToCart({{ product.id }})" class="mt-3 w-full theme-button py-2 rounded-lg transition-colors duration-300 flex items-center justify-center">
                                <span class="add-to-cart-text">Add to Cart</span>
                                <svg class="spinner hidden w-5 h-5 ml-2 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                                </svg>
                            </button>
                        </div>
                    </a>
                {% endfor %}
            {% else %}
                <div class="text-center py-10">
                    <p class="text-lg">Oops! No products available at the moment.</p>
                    <a href="{% url 'marketplace:seller_dashboard' %}" class="theme-link">Are you a seller? Add products now!</a>
                </div>
            {% endif %}
        </div>

        <!-- Cart Summary -->
        <div class="mt-8 theme-container rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Cart Summary</h2>
            {% if cart_items %}
                <p>Items: <span id="cart-count">{{ cart_items.count }}</span></p>
                <p>Total: KSh <span id="cart-total">{{ cart_total }}</span></p>
                <a href="{% url 'marketplace:cart' %}" class="inline-block mt-4 theme-button py-2 px-6 rounded-lg transition-colors duration-300">
                    View Cart
                </a>
            {% else %}
                <p>Your cart is empty.</p>
                <a href="{% url 'marketplace:home' %}" class="theme-link">Start Shopping</a>
            {% endif %}
        </div>
    </div>

    <script>
        function addToCart(productId) {
            const button = event.currentTarget;
            const text = button.querySelector('.add-to-cart-text');
            const spinner = button.querySelector('.spinner');
            text.classList.add('hidden');
            spinner.classList.remove('hidden');
            button.disabled = true;

            fetch(`/cart/add/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quantity: 1 }),
            })
            .then(response => response.json())
            .then(data => {
                text.classList.remove('hidden');
                spinner.classList.add('hidden');
                button.disabled = false;
                if (data.success) {
                    document.getElementById('cart-count').innerText = data.cart_count;
                    document.getElementById('cart-total').innerText = data.cart_total;
                    alert('Product added to cart!');
                } else {
                    alert('Error adding product to cart.');
                }
            })
            .catch(error => {
                text.classList.remove('hidden');
                spinner.classList.add('hidden');
                button.disabled = false;
                console.error('Error:', error);
                alert('Error adding product to cart.');
            });
        }

        document.querySelectorAll('.read-more').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const productId = link.getAttribute('data-product-id');
                const desc = document.getElementById(`desc-${productId}`);
                const fullDesc = desc.querySelector('.full-desc');
                if (link.textContent === 'read more...') {
                    desc.innerHTML = `${fullDesc.textContent} <a href="#" class="read-more theme-link" data-product-id="${productId}">read less</a>`;
                } else {
                    desc.innerHTML = `${fullDesc.textContent|truncatechars:100} <a href="#" class="read-more theme-link" data-product-id="${productId}">read more...</a> <span class="hidden full-desc">${fullDesc.textContent}</span>`;
                }
            });
        });
    </script>
{% endblock %}